---
date: "2019-08-12"
title: "memory-leak-with-react"
description: "Reactì—ì„œ ë¹„ ë™ê¸° í˜¸ì¶œ ì‹œ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ì¤„ì´ëŠ” ë°©ë²• with Hooks"
banner: "./images/banner.jpg"
published: true
---

`React` ì½”ë“œë¥¼ ì‘ì„±í•˜ë©´ì„œ `state` ê°’ì„ ë¹„ ë™ê¸°ë¡œ ë³€ê²½í•˜ì—¬ DOMì˜ ë…¸ì¶œ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ëŠ” ì‚¬ë¡€ëŠ” ì¼ë°˜ì ì…ë‹ˆë‹¤. ì•„ë˜ ì½”ë“œëŠ” `Show` ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ `Child` ì»´í¬ë„ŒíŠ¸ê°€ ë Œë”ë§ ë˜ë©´ 2ì´ˆ ë’¤ì— `state`ê°’ì„ ë³€ê²½í•˜ëŠ” ê°„ë‹¨í•œ ì½”ë“œì…ë‹ˆë‹¤. (ë¹„ë™ê¸° í˜¸ì¶œì€ `setTimeout`ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤. ğŸ˜€)

```jsx
function Child() {
  const [state, setState] = React.useState("mountğŸ™‚")
  React.useEffect(() => {
    setTimeout(() => {
      setState("updateğŸ™ƒ")
    }, 2000)
  }, [])

  return <div>{state}</div>
}

function App() {
  const [view, setView] = React.useState(false)
  const onShowClick = () => {
    setView(true)
  }
  const onHideClick = () => {
    setView(false)
  }

  return (
    <div className="App">
      <button onClick={onShowClick}>Show</button>
      <button onClick={onHideClick}>Hide</button>
      {view && <Child />}
    </div>
  )
}
```

`Show`ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ `view` ìƒíƒœ ê°’ì´ `true`ë¡œ ë³€ê²½ë˜ë©´ì„œ `App` ì»´í¬ë„ŒíŠ¸ëŠ” ë‹¤ì‹œ ë Œë”ë§ ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  `Child` ì»´í¬ë„ŒíŠ¸ê°€ ë Œë”ë§ ë˜ê³  DOMì„ ê·¸ë¦¬ê³  `useEffect` ì‹¤í–‰í•˜ê³  ê·¸ ì•ˆì— `setTimeout` ì½œë°± í•¨ìˆ˜ê°€ 2ì´ˆ ë’¤ì— ì‹¤í–‰ë©ë‹ˆë‹¤.

ìœ„ì™€ ê°™ì€ ë¡œì§ì´ ì •ìƒ ì‘ë™í•˜ë©´ ë¬¸ì œê°€ ì—†ê² ì§€ë§Œ, `setTimeout`ì˜ ì½œë°± í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ê¸° ì „ì— `Child`ì»´í¬ë„ŒíŠ¸ë¥¼ `unmount` ì‹œí‚¨ë‹¤ë©´ ì–´ë–¤ ìƒí™©ì´ ë°œìƒí• ê¹Œìš”? ì½˜ì†” ì°½ì—ì„œëŠ” ì´ëŸ¬í•œ ë¬¸êµ¬ê°€ ë“±ì¥í•©ë‹ˆë‹¤.

> âš ï¸ Warning: Can't perform a React state update on an unmounted component. This is a no-op, but it indicates a memory leak in your application. To fix, cancel all subscriptions and asynchronous tasks in a useEffect cleanup function.

        in Child (created by App)

ìœ„ `warning`ì— í† ëŒ€ë¡œ `return` í•¨ìˆ˜ì— ìƒíƒœ ê°’ì„ ë³€ê²½ì„ ì·¨ì†Œí•˜ëŠ” ë¡œì§ì„ ì¶”ê°€í•´ë´…ì‹œë‹¤. Reactì—ì„œ ì›í•˜ëŠ” í˜•íƒœëŠ” ì•„ë§ˆë„ ì´ëŸ¬í•œ í˜•íƒœì¼ê±° ê°™ìŠµë‹ˆë‹¤.

```jsx
React.useEffect(() => {
  // do something
  return () => // cancelling state
}
```

`setTimeout` ì˜ ê²½ìš° `clearTimeout`ì„ ì‚¬ìš©í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ ì œì–´ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

```jsx
// Child Component
React.useEffect(() => {
  const timer = setTimeout(() => {
    setState("updateğŸ™ƒ")
  }, 2000)

  return () => {
    clearTimeout(timer)
  }
}, [])
```

ë¹„ ë™ê¸° í˜¸ì¶œì˜ ì˜ˆì œë¥¼ ìœ„í•´ `setTimeout`ë¥¼ ì‚¬ìš©í–ˆì§€ë§Œ ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ê²½ìš°ì—ëŠ” ìƒí™©ì´ ë‹¤ë¦…ë‹ˆë‹¤. `axios`ë¥¼ ì‚¬ìš©í•´ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ê²½ìš° ì½œë°± í•¨ìˆ˜ë¥¼ ë¹„ìš°ëŠ” `clearTimeout`ì´ë¼ëŠ” í•¨ìˆ˜ê°€ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

`axios` ê°™ì€ ê²½ìš° ìš”ì²­ì´ ì™„ë£Œí•˜ê¸° ì „ì— ì»´í¬ë„ŒíŠ¸ê°€ `unmount`ë˜ëŠ” ê²½ìš° `cancelToken`[[ë§í¬]](https://github.com/axios/axios#cancellation) ì„ ì´ìš©í•´ ìš”ì²­ì„ ì·¨ì†Œí•˜ê±°ë‚˜ `useRef`ë¥¼ ì‚¬ìš©í•´ ì²˜ë¦¬í•  ìˆ˜ë„ ìˆì§€ë§Œ, ì¢€ ë” ê°„ë‹¨íˆ ì‘ì„±í•˜ëŠ” ë°©ë²•ì€ `clusure`ë¥¼ ì´ìš©í•˜ëŠ” ë²•ì…ë‹ˆë‹¤.

```jsx
// Child Component
React.useEffect(() => {
  let isSubscribed = true

  setTimeout(() => {
    if (isSubscribed) {
      setState("updateğŸ™ƒ")
    }
  }, 1000)

  return () => {
    isSubscribed = false
  }
}, [])
```

ë¡œì§ì´ ëŒì•„ê°€ëŠ” ê³¼ì •ì„ ì„¤ëª…í•˜ë©´, ê¸°ì¡´ ë™ì‘ ê³¼ì •ì€ ë™ì¼í•˜ì§€ë§Œ `isSubscribed`ë¼ëŠ” ë³€ìˆ˜ê°€ ì¶”ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤. `isSubscribed` ë³€ìˆ˜ë¥¼ í†µí•´ `state` ìƒíƒœ ê°’ì„ ë³€ê²½í• ì§€ ê²°ì •í•©ë‹ˆë‹¤. `unmount`ê°€ ë˜ëŠ” ìˆœê°„ `isSubscribed`ëŠ” `false`ë¡œ ê°’ì´ ë³€ê²½ë˜ê³  ìƒíƒœ ê°’ì„ ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ìœ„ì™€ ê°™ì€ ë°©ë²•ìœ¼ë¡œ ë¹„ ë™ê¸° í˜¸ì¶œ ì‹œ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ì „ì²´ ì½”ë“œëŠ” ì•„ë˜ì˜ ë§í¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[Memory leak with React - CodeSandbox](https://codesandbox.io/s/memory-leak-with-react-oyybw)
